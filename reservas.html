<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas Spa - Zenith Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Specific rules for Spa Turns Grid */
        .grid-7 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .slot-card {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .slot-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .slot-card.active {
            border-color: var(--accent);
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .slot-card.full {
            opacity: 0.7;
            background: #fdf2f2;
            cursor: not-allowed;
            border-color: #ff5252;
        }

        .slot-card.blocked {
            background: #f0f0f0;
            opacity: 0.6;
            cursor: not-allowed;
            border-style: dashed;
        }

        .pax-badge {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 5px 0;
            color: var(--text);
        }

        .time-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .progress-mini {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s;
        }

        /* Forms in Reservas */
        .form-section-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-section-label i {
            color: var(--accent);
            font-size: 0.8rem;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .sidebar {
            z-index: 100 !important;
        }

        .main-content {
            padding: 30px !important;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div style="text-align: center; margin-bottom: 25px;">
            <img src="logo-spa.jpg" alt="Cumbria Bienestar" style="max-width: 85%; height: auto;">
        </div>

        <ul class="nav-links">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Inicio</a></li>
            <li><a href="index.html" class="nav-link"><i class="fas fa-ticket-alt"></i> Bonos</a></li>
            <li><a href="reservas.html?type=spa" class="nav-link"><i class="fas fa-calendar-alt"></i> Panel General
                    (Spa)</a></li>
            <li><a href="reservas.html?type=suite" class="nav-link"><i class="fas fa-gem"></i> Suite Spa</a></li>
            <li><a href="reservas.html?type=panacea" class="nav-link"><i class="fas fa-tint"></i> Sala Panacea</a></li>
            <li><a href="reservas.html?type=vip" class="nav-link"><i class="fas fa-crown"></i> Sala VIP</a></li>
            <!-- <li><a href="reservas.html?type=peluqueria" class="nav-link"><i class="fas fa-cut"></i> Peluquería</a></li> -->
            <li style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                <a href="personal.html" class="nav-link"><i class="fas fa-users-cog"></i> Gestión Personal</a>
            </li>
        </ul>

        <div style="text-align: center; margin-top: auto; padding: 10px 0; border-top: 1px solid var(--border);">
            <img src="zenith-logo.png" alt="Zenith" style="max-width: 90px; height: auto; opacity: 0.85;">
        </div>
    </div>


    <main class="main-content">
        <header class="header-flex">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="zenith-logo.png" alt="Zenith Logo" style="height: 40px; width: auto; margin-right: -5px;">
                <h2 style="margin: 0; line-height: 1;">PANEL DE TURNOS</h2>
                <input type="date" id="main-date-picker" class="param-input" style="width: 180px;">

                <label class="switch-container">
                    <input type="checkbox" id="show-cancelled"
                        onchange="loadReservas(document.getElementById('main-date-picker').value)"
                        style="width: 14px; height: 14px; cursor:pointer;">
                    Ver Anuladas
                </label>
            </div>
            <div id="status-legend" style="display: flex; gap: 15px; font-size: 0.75rem; color: var(--text-muted);">
                <span><i class="fas fa-circle" style="color: #4caf50;"></i> Libre</span>
                <span><i class="fas fa-circle" style="color: #ff9800;"></i> Casi lleno</span>
                <span><i class="fas fa-circle" style="color: #f44336;"></i> Completo</span>
            </div>
        </header>

        <!-- Dynamic Grid of Slots -->
        <div id="slots-container" class="grid-7">
            <!-- Rendered by JS -->
        </div>

        <!-- Hourly Details / Selected Slot -->
        <div id="details-section" style="margin-top: 25px; display: none;">
            <div class="stat-card" style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="details-title" style="font-size: 1rem; font-weight: 600;">Reservas para las 10:00h</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="btn-lock-slot" class="btn btn-outline btn-sm" onclick="toggleSlotLock()"
                            style="border-color: #666; color: #666;">
                            <i class="fas fa-lock"></i> Cerrar Turno
                        </button>
                        <button class="btn btn-accent btn-sm" onclick="showBookingForm()">
                            <i class="fas fa-plus"></i> Añadir Reserva
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente / Tel</th>
                                <th>Origen</th>
                                <th>Hab</th>
                                <th>Pax</th>
                                <th>Precio/Pax</th>
                                <th>Total</th>
                                <th>Obs</th>
                                <th style="text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="details-table-body">
                            <!-- Filled dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL RESERVA ULTRA-COMPACT -->
    <div id="booking-modal" class="modal">
        <div class="modal-content" style="max-width: 820px; padding: 12px 20px; border-radius: 12px;">
            <span class="close-modal" onclick="closeModal()"
                style="top: 8px; right: 12px; font-size: 1.2rem;">&times;</span>

            <div class="modal-header"
                style="margin-bottom: 0px; border: none; display: flex; justify-content: space-between; align-items: baseline;">
                <h3 id="modal-title" style="font-size: 1.3rem; font-weight: 300; color: var(--text); margin: 0;">Nueva
                    Reserva</h3>
                <span id="res-id-display" class="res-id-badge"
                    style="background: none; color: #a0aec0; border: none; font-size: 0.8rem; letter-spacing: 1px; font-weight: 700;">NUEVA</span>
            </div>

            <p id="modal-subtitle" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;"></p>
            <div id="audit-info"
                style="position: absolute; top: 38px; right: 20px; font-size: 0.55rem; color: #bbb; text-align: right; line-height: 1;">
            </div>

            <form id="booking-form" style="display: flex; flex-direction: column; gap: 8px;">
                <input type="hidden" id="form-id">
                <input type="hidden" id="form-date">
                <input type="hidden" id="form-time">

                <!-- FILA 1: CLIENTE (GROW), PAX (FIXED), TELÉFONO (FIXED) -->
                <div style="display: grid; grid-template-columns: 1fr 100px 180px; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-user"></i> CLIENTE
                        </label>
                        <input type="text" id="res-nombre" required placeholder="Nombre completo"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; height: 34px; background: #fff;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-users"></i> PAX
                        </label>
                        <input type="number" id="res-pax" value="2" min="1" max="25" required
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; height: 34px; background: #fff;">
                    </div>
                    <div class="form-group" id="tel-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-phone"></i> TELÉFONO
                        </label>
                        <input type="tel" id="res-tel" required placeholder="XXX XXX XXX" pattern="\d{3} \d{3} \d{3}"
                            minlength="11" maxlength="11"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; height: 34px; background: #fff;">
                    </div>
                </div>

                <!-- FILA 2: ORIGEN (50%), SERVICIO (50%) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-tag"></i> ORIGEN
                        </label>
                        <select id="res-origen" onchange="toggleRoomField()"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; background: #fff; height: 34px;">
                            <option value="particular">Particular (Pago)</option>
                            <option value="hotel_inc">Hotel - Incluido</option>
                            <option value="hotel_no_inc">Hotel - NO Incluidos</option>
                            <option value="bono">Bono Spa (Interno)</option>
                            <option value="smartbox">Smartbox</option>
                            <option value="wonderbox">Wonderbox</option>
                            <option value="ego">Ego Experiencias</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-spa"></i> SERVICIO
                        </label>
                        <select id="res-servicio" required
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; background: #fff; height: 34px;">
                            <option value="Circuito Spa">Circuito Spa</option>
                        </select>
                    </div>
                </div>

                <!-- FILA 3: CAMPOS DINÁMICOS -->
                <div id="extra-fields-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="form-group" id="hotel-group" style="display:none; margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-hotel"></i> HOTEL
                        </label>
                        <select id="res-hotel"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; background: #fff; height: 34px;">
                            <option value="Cumbria">Cumbria</option>
                            <option value="Guadiana">Guadiana</option>
                        </select>
                    </div>
                    <div class="form-group" id="room-group" style="display:none; margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-door-open"></i> HABITACIÓN
                        </label>
                        <input type="text" id="res-hab" placeholder="Nº"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; height: 34px; background: #fff;">
                    </div>
                    <div class="form-group" id="bono-group" style="display:none; margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-ticket-alt"></i> ID BONO
                        </label>
                        <input type="text" id="res-bono" placeholder="Código"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; height: 34px; background: #fff;">
                    </div>
                    <div class="form-group" id="sessions-group" style="display:none; margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-redo"></i> SESIONES
                        </label>
                        <input type="number" id="res-sesiones" value="1" min="1" max="10"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; height: 34px; background: #fff;">
                    </div>
                </div>

                <!-- FILA 4: OBSERVACIONES + PRECIOS -->
                <div style="display: grid; grid-template-columns: 1.5fr 0.5fr 1fr; gap: 10px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-comment-dots"></i> OBSERVACIONES
                        </label>
                        <textarea id="res-obs" placeholder="Notas internas..." rows="1"
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; width: 100%; height: 34px; resize: none; background: #fff;"></textarea>
                    </div>
                    <div class="form-group" id="price-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-euro-sign"></i> P.PAX
                        </label>
                        <input type="number" id="res-precio-pax" step="0.01" value="0" required
                            style="padding: 8px 10px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.85rem; width: 100%; height: 34px; background: #fff;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="text-transform: uppercase; font-size: 0.6rem; font-weight: 700; color: #a0aec0; letter-spacing: 0.5px; margin-bottom: 3px;">TOTAL</label>
                        <div id="res-total-display"
                            style="font-size: 1rem; font-weight: 800; color: var(--accent); background: #fdfaf0; padding: 0 10px; border-radius: 6px; border: 1px solid #ffeeba; text-align: center; height: 34px; display: flex; align-items: center; justify-content: center;">
                            <span id="res-total-text">0.00 €</span>
                        </div>
                        <input type="hidden" id="res-precio-total" value="0">
                    </div>
                </div>

                <!-- ACCIONES -->
                <div class="form-actions" style="display: flex; gap: 8px; margin-top: 4px;">
                    <button type="submit" class="btn btn-accent"
                        style="flex: 2; padding: 0 10px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; height: 36px;">
                        <i class="fas fa-check"></i> GUARDAR RESERVA
                    </button>
                    <button type="button" id="btn-cancelar" class="btn btn-outline"
                        style="flex: 1; border-color: #feb2b2; color: #f56565; display: none; padding: 0 10px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; height: 36px;"
                        onclick="cancelBookingFromModal()">
                        <i class="fas fa-trash"></i> ANULAR
                    </button>
                    <button type="button" class="btn btn-outline"
                        style="flex: 1; padding: 0 10px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; height: 36px;"
                        onclick="closeModal()">
                        <i class="fas fa-times"></i> SALIR
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();

        // ------------------- CONFIGURACIÓN DE MÓDULOS -------------------
        const SLOTS_SPA_WEEK = ["10:00", "11:00", "12:15", "13:30", "15:45", "16:45", "18:00", "19:00", "20:30"];
        const SLOTS_SPA_SUN = ["10:00", "11:00", "12:15", "13:30"];

        // Generar slots de 15 min de 10:00 a 21:45
        const SLOTS_15_MIN = [];
        for (let h = 10; h <= 21; h++) {
            for (let m = 0; m < 60; m += 15) {
                const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                SLOTS_15_MIN.push(time);
            }
        }
        // Aseguramos que termine en 21:45 (el loop lo cubre)

        const MODULES = {
            'spa': {
                name: 'PANEL DE TURNOS (SPA)',
                collection: 'reservas_spa',
                capacity: 20,
                slotsWeek: SLOTS_SPA_WEEK,
                slotsSun: SLOTS_SPA_SUN,
                isPrivate: false,
                requiresStaff: false,
                viewType: 'grid'
            },
            'suite': {
                name: 'SUITE SPA',
                collection: 'reservas_suite',
                capacity: 1,
                slotsWeek: SLOTS_15_MIN,
                slotsSun: SLOTS_15_MIN, // Asumimos mismo horario por ahora
                isPrivate: true,
                requiresStaff: false, // Auto-flag: Suite NO consume personal
                viewType: 'timeline'
            },
            'panacea': {
                name: 'SALA SPA PANACEA',
                collection: 'reservas_panacea',
                capacity: 1,
                isPrivate: true,
                requiresStaff: true, // Consume personal
                viewType: 'timeline'
            },
            'vip': {
                name: 'SALA VIP',
                collection: 'reservas_vip',
                capacity: 1,
                isPrivate: true,
                requiresStaff: true, // Consume personal
                viewType: 'timeline'
            },
            'peluqueria': {
                name: 'PELUQUERÍA',
                collection: 'reservas_peluqueria',
                capacity: 2,
                isPrivate: false,
                requiresStaff: true,
                viewType: 'grid' // O timeline, a definir
            }
        };

        // Detectar módulo actual
        const urlParams = new URLSearchParams(window.location.search);
        const moduleType = urlParams.get('type') || 'spa';
        const currentModule = MODULES[moduleType] || MODULES['spa'];

        console.log("Módulo activo:", currentModule.name);

        // Actualizar Título
        document.querySelector('h2').textContent = currentModule.name;

        // Configuración Global de Personal (Cargada al inicio)
        let staffConfig = { morning: 2, afternoon: 2 };

        function formatDateTime(isoStr) {
            if (!isoStr) return "";
            const d = new Date(isoStr);
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                ' ' + d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        let currentData = [];
        let selectedTime = null;
        let baseCircuitoPrice = 0;
        let spaConfig = {
            capacity: currentModule.capacity,
            closedDates: []
        };

        document.addEventListener("DOMContentLoaded", async () => {
            const picker = document.getElementById("main-date-picker");
            const urlDate = urlParams.get('date');
            const initialDate = urlDate || new Date().toISOString().split('T')[0];
            picker.value = initialDate;

            await cargarSpaConfig();
            await loadStaffConfig(); // Cargar capacidad de personal

            if (currentModule.isPrivate) spaConfig.capacity = 1;

            fetchBasePrice();
            picker.addEventListener("change", () => loadReservas(picker.value));

            // Ajustar UI según modo
            if (currentModule.viewType === 'timeline') {
                document.getElementById('slots-container').classList.add('timeline-view');
                // Inyectar campo duración en modal si no existe
                injectDurationField();
            }

            await loadReservas(initialDate);

            // Manejar salto a reserva específica
            const resId = urlParams.get('res_id');
            if (resId) {
                const targetRes = currentData.find(r => r.id === resId);
                if (targetRes) {
                    selectSlot(targetRes.hora, false, false);
                    setTimeout(() => {
                        const row = document.getElementById(`res-${resId}`);
                        if (row) {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.style.background = "rgba(212, 175, 55, 0.2)";
                            setTimeout(() => row.style.background = "", 3000);
                        }
                        // Abrir modal automáticamente
                        editBooking(resId);
                    }, 600);
                }
            }

            // ... (rest of DOMContentLoaded) ...

            // Verificar si venimos de reservar un bono desde el Dashboard
            const pendingBooking = sessionStorage.getItem('pendingVoucherBooking');
            if (pendingBooking) {
                const data = JSON.parse(pendingBooking);
                const msg = document.createElement("div");
                msg.id = "v-booking-notice";
                msg.style = "background: var(--accent); color: white; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;";

                let infoExtra = data.sesiones_restantes ? ` (Saldo: ${data.sesiones_restantes} ses.)` : "";

                msg.innerHTML = `
                    <span><i class="fas fa-ticket-alt"></i> Reservando para <b>${data.cliente}</b>${infoExtra}. Selecciona un turno.</span>
                    <button onclick="clearPendingVoucher()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-times"></i></button>
                `;
                document.querySelector(".header-flex").after(msg);
            }

            // Price automation listeners
            document.getElementById("res-origen").addEventListener("change", updatePriceAutomation);
            document.getElementById("res-pax").addEventListener("input", updatePriceAutomation);
            document.getElementById("res-precio-pax").addEventListener("input", () => {
                const pax = parseInt(document.getElementById("res-pax").value) || 1;
                const pPax = parseFloat(document.getElementById("res-precio-pax").value) || 0;
                const total = pPax * pax;
                document.getElementById("res-precio-total").value = total.toFixed(2);
                document.getElementById("res-total-text").textContent = total.toFixed(2) + " €";
            });

            // Formatear teléfono: 3 bloques de 3 números (XXX XXX XXX)
            document.getElementById("res-tel").addEventListener("input", (e) => {
                let value = e.target.value.replace(/\D/g, ""); // Solo números
                if (value.length > 9) value = value.slice(0, 9); // Límite de 9

                let formattedValue = "";
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 3 === 0) formattedValue += " ";
                    formattedValue += value[i];
                }
                e.target.value = formattedValue;
            });

            // Validación de saldo de bonos en tiempo real
            async function triggerBalanceCheck() {
                const origen = document.getElementById("res-origen").value;
                const bonoId = document.getElementById("res-bono").value.trim();
                const resId = document.getElementById("form-id").value;

                if (origen === "bono" && bonoId) {
                    await validateBonoBalance(bonoId, resId);
                } else {
                    document.getElementById("res-sesiones").removeAttribute("max");
                    const notice = document.getElementById("v-balance-notice");
                    if (notice) notice.style.display = "none";
                }
            }

            document.getElementById("res-origen").addEventListener("change", triggerBalanceCheck);
            document.getElementById("res-bono").addEventListener("blur", triggerBalanceCheck);
        });

        async function validateBonoBalance(bonoId, currentResId = null) {
            try {
                const doc = await db.collection("spa_vouchers").doc(bonoId).get();
                if (!doc.exists) return;

                const data = doc.data();
                const total = data.sesiones_totales || 1;
                const used = data.sesiones_usadas || 0;

                let balance = total - used;

                // Si estamos editando, las sesiones de ESTA reserva cuentan como disponibles
                if (currentResId) {
                    const currentRes = currentData.find(r => r.id === currentResId);
                    if (currentRes && currentRes.bono === bonoId) {
                        balance += (currentRes.sesiones_consumidas || 1);
                    }
                }

                const sesionesInput = document.getElementById("res-sesiones");
                sesionesInput.setAttribute("max", balance);

                // Mostrar aviso visual
                let notice = document.getElementById("v-balance-notice");
                if (!notice) {
                    notice = document.createElement("div");
                    notice.id = "v-balance-notice";
                    notice.className = "form-group";
                    notice.style = "grid-column: 1 / -1; font-size: 0.75rem; padding: 8px 12px; border-radius: 6px; margin-top: -10px; display: none; align-items: center; gap: 8px;";
                    document.getElementById("sessions-group").after(notice);
                }

                if (balance <= 0) {
                    notice.style.display = "flex";
                    notice.style.background = "#fff2f2";
                    notice.style.color = "#d32f2f";
                    notice.style.border = "1px solid #ffdada";
                    notice.innerHTML = `<i class="fas fa-exclamation-circle"></i> <b>BONO AGOTADO.</b> No quedan sesiones disponibles.`;
                    sesionesInput.value = 0;
                } else {
                    notice.style.display = "flex";
                    notice.style.background = "rgba(212, 175, 55, 0.1)";
                    notice.style.color = "var(--accent)";
                    notice.style.border = "1px solid var(--accent)";
                    notice.innerHTML = `<i class="fas fa-info-circle"></i> Saldo disponible: <b>${balance} sesiones</b>.`;

                    // Ajustar si el valor actual es mayor al balance
                    if (parseInt(sesionesInput.value) > balance) {
                        sesionesInput.value = balance;
                    }
                }

            } catch (err) {
                console.warn("Error validando saldo del bono:", err);
            }
        }

        function generateUID() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let res = '';
            for (let i = 0; i < 4; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return `RS-${res}`;
        }

        async function fetchBasePrice() {
            try {
                // Buscamos el servicio "Circuito SPA" para sacar su precio base
                const snapshot = await db.collection("spa_services")
                    .where("nombre", ">=", "Circuito")
                    .get();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombre.toLowerCase().includes("circuito spa") || data.nombre.toLowerCase() === "circuito") {
                        baseCircuitoPrice = parseFloat(data.precio) || 0;
                        console.log("Precio base detectado:", baseCircuitoPrice);
                    }
                });

                if (baseCircuitoPrice === 0) {
                    // Fallback si no se encuentra
                    baseCircuitoPrice = 30; // Precio por defecto razonable
                }
            } catch (err) {
                console.error("Error fetching price:", err);
                baseCircuitoPrice = 30;
            }
        }

        function updatePriceAutomation() {
            const origen = document.getElementById("res-origen").value;
            const pax = parseInt(document.getElementById("res-pax").value) || 1;
            const pricePaxInput = document.getElementById("res-precio-pax");
            const priceTotalInput = document.getElementById("res-precio-total");

            if (origen === 'particular' || origen === 'hotel_no_inc') {
                const total = baseCircuitoPrice * pax;
                pricePaxInput.value = baseCircuitoPrice.toFixed(2);
                priceTotalInput.value = total.toFixed(2);
                document.getElementById("res-total-text").textContent = total.toFixed(2) + " €";
            } else {
                pricePaxInput.value = (0).toFixed(2);
                priceTotalInput.value = (0).toFixed(2);
                document.getElementById("res-total-text").textContent = "0.00 €";
            }
        }

        async function cargarSpaConfig() {
            try {
                const doc = await db.collection("spa_config").doc("settings").get();
                if (doc.exists) {
                    spaConfig = { ...spaConfig, ...doc.data() };
                }
            } catch (err) {
                console.error("Error loading spa_config:", err);
            }
        }

        async function loadReservas(date) {
            try {
                // Verificar si el día está cerrado
                if (spaConfig.closedDates.includes(date)) {
                    document.getElementById("slots-container").innerHTML = `
                        <div style="grid-column: 1 / -1; background: #ffebee; color: #d32f2f; padding: 40px; border-radius: 12px; text-align: center; border: 1px solid #ffcdd2;">
                            <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                            <h3 style="margin:0;">DÍA CERRADO</h3>
                            <p style="margin-top:10px; opacity:0.8;">Este día no acepta reservas por configuración de sistema.</p>
                        </div>
                    `;
                    document.getElementById("details-section").style.display = "none";
                    return;
                }

                const snapshot = await db.collection(currentModule.collection)
                    .where("fecha", "==", date)
                    .get();

                currentData = [];
                snapshot.forEach(doc => currentData.push({ id: doc.id, ...doc.data() }));

                renderSlots(date);
                if (selectedTime) updateDetails(selectedTime);
            } catch (err) {
                console.error("Error:", err);
            }
        }

        function renderSlots(dateString) {
            if (currentModule.viewType === 'timeline') {
                renderTimeline(dateString);
                return;
            }

            const date = new Date(dateString);
            const isSunday = date.getDay() === 0;
            const slots = isSunday ? currentModule.slotsSun : currentModule.slotsWeek;
            const container = document.getElementById("slots-container");

            const dateBlockedSlots = (spaConfig.blockedSlots && spaConfig.blockedSlots[dateString]) || [];

            container.innerHTML = slots.map(time => {
                const dayReservations = currentData.filter(r => r.hora === time && r.status !== 'anulada');
                const paxTotal = dayReservations.reduce((sum, r) => sum + (r.pax || 0), 0);
                const maxCapacity = spaConfig.capacity || 20;
                const isFull = paxTotal >= maxCapacity;
                const isBlocked = dateBlockedSlots.includes(time);

                let color = "#4caf50"; // Green
                if (isFull || isBlocked) color = "#f44336"; // Red
                else if (paxTotal > (maxCapacity * 0.75)) color = "#ff9800"; // Orange

                const percent = (paxTotal / maxCapacity) * 100;

                return `
                    <div class="slot-card ${isFull ? 'full' : ''} ${isBlocked ? 'blocked' : ''} ${selectedTime === time ? 'active' : ''}" 
                         onclick="selectSlot('${time}', ${isFull}, ${isBlocked})">
                        <div class="time-label">${time}</div>
                        ${isBlocked ?
                        '<div class="pax-badge" style="color: #666; font-size: 0.9rem; margin: 15px 0;">CERRADO</div>' :
                        `<div class="pax-badge" style="color: ${color}">${paxTotal}<span style="font-size: 0.8rem; color: #999; font-weight: 400;">/${maxCapacity}</span></div>`
                    }
                        <div style="font-size: 0.65rem; color: var(--text-muted); font-weight: 500;">
                            ${isBlocked ? 'Turno no disponible' : (isFull ? 'COMPLETO' : (maxCapacity - paxTotal) + ' disponibles')}
                        </div>
                        <div class="progress-mini">
                            <div class="progress-bar" style="width: ${isBlocked ? 100 : Math.min(percent, 100)}%; background: ${isBlocked ? '#ccc' : color}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectSlot(time, isFull, isBlocked) {
            selectedTime = time;
            const dateStr = document.getElementById("main-date-picker").value;
            renderSlots(dateStr);

            document.getElementById("details-section").style.display = "block";
            document.getElementById("details-title").textContent = `Reservas para las ${time}h`;

            // Actualizar botón de bloqueo
            const btnLock = document.getElementById("btn-lock-slot");
            if (isBlocked) {
                btnLock.innerHTML = '<i class="fas fa-lock-open"></i> Abrir Turno';
                btnLock.style.borderColor = "var(--accent)";
                btnLock.style.color = "var(--accent)";
            } else {
                btnLock.innerHTML = '<i class="fas fa-lock"></i> Cerrar Turno';
                btnLock.style.borderColor = "#666";
                btnLock.style.color = "#666";
            }

            updateDetails(time);
        }

        async function toggleSlotLock() {
            if (!selectedTime) return;
            const dateStr = document.getElementById("main-date-picker").value;
            if (!spaConfig.blockedSlots) spaConfig.blockedSlots = {};
            if (!spaConfig.blockedSlots[dateStr]) spaConfig.blockedSlots[dateStr] = [];

            const index = spaConfig.blockedSlots[dateStr].indexOf(selectedTime);
            if (index > -1) {
                // Abrir
                spaConfig.blockedSlots[dateStr].splice(index, 1);
                if (spaConfig.blockedSlots[dateStr].length === 0) delete spaConfig.blockedSlots[dateStr];
            } else {
                // Cerrar
                if (!confirm(`¿Deseas CERRAR el turno de las ${selectedTime}h para el día ${dateStr}? No se podrán añadir nuevas reservas.`)) return;
                spaConfig.blockedSlots[dateStr].push(selectedTime);
            }

            try {
                await db.collection("spa_config").doc("settings").set(spaConfig);
                renderSlots(dateStr);
                // Forzar re-selección para actualizar botón
                const isBlocked = (spaConfig.blockedSlots[dateStr] || []).includes(selectedTime);
                selectSlot(selectedTime, false, isBlocked);
            } catch (err) {
                alert("Error al guardar bloqueo: " + err.message);
            }
        }

        function updateDetails(time) {
            const showCancelled = document.getElementById("show-cancelled").checked;
            let list = currentData.filter(r => r.hora === time);

            if (!showCancelled) {
                list = list.filter(r => r.status !== 'anulada');
            }

            const body = document.getElementById("details-table-body");

            if (list.length === 0) {
                body.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999; padding: 20px;">No hay reservas para este turno.</td></tr>';
                return;
            }

            body.innerHTML = list.map(res => {
                let badgeClass = "badge-particular";
                let badgeText = "Particular";

                if (res.origen === 'hotel_inc') { badgeClass = "badge-hotel-inc"; badgeText = "Hot. Inc"; }
                else if (res.origen === 'hotel_no_inc') { badgeClass = "badge-hotel-no"; badgeText = "Hot. NO Inc"; }
                else if (res.origen === 'bono') { badgeClass = "badge-bono"; badgeText = "Bono Spa"; }
                else if (res.origen === 'smartbox') { badgeClass = "badge-smartbox"; badgeText = "Smartbox"; }
                else if (res.origen === 'wonderbox') { badgeClass = "badge-wonderbox"; badgeText = "Wonderbox"; }
                else if (res.origen === 'ego') { badgeClass = "badge-ego"; badgeText = "Ego Exp"; }

                const isAnulada = res.status === 'anulada';

                return `
                <tr id="res-${res.id}" class="${isAnulada ? 'cancelled-row' : ''}">
                    <td style="font-size: 0.65rem; color: #666; font-weight: 700;">${res.res_id || '-'}</td>
                    <td>
                        <div style="font-weight: 600;">${res.nombre}</div>
                        <div style="font-size: 0.7rem; color: #999;">${res.tel || '-'} ${res.bono ? ' | <i class="fas fa-ticket-alt"></i> ' + res.bono : ''}</div>
                    </td>
                    <td>
                        ${isAnulada ? '<span class="badge badge-anulada">ANULADA</span>' : `<span class="badge ${badgeClass}">${badgeText}</span>`}
                    </td>
                    <td style="font-weight: 600;">
                        ${res.hab ? (res.hotel || 'Cumbria') + ' - ' + res.hab : '-'}
                    </td>
                    <td style="font-weight: 700; color: var(--accent);">${res.pax} pax</td>
                    <td style="font-weight: 600;">${res.precio_pax ? res.precio_pax + '€' : '-'}</td>
                    <td style="font-weight: 700;">${res.precio_total ? res.precio_total + '€' : '0€'}</td>
                    <td style="text-align: center;">
                        ${res.obs ? `
                            <div class="tooltip">
                                <i class="fas fa-comment-dots" style="color: var(--accent);"></i>
                                <span class="tooltiptext"><strong>Observaciones:</strong><br>${res.obs}</span>
                            </div>
                        ` : '-'}
                    </td>
                    <td style="text-align: right;">
                        <button class="btn btn-outline btn-sm" onclick="editBooking('${res.id}')" style="padding: 2px 8px;"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        function updateTotal() {
            const pax = parseInt(document.getElementById("res-pax").value) || 0;
            const pricePax = parseFloat(document.getElementById("res-precio-pax").value) || 0;
            const total = pax * pricePax;
            document.getElementById("res-precio-total").value = total;
            document.getElementById("res-total-text").textContent = total.toFixed(2) + " €";
        }

        document.getElementById("res-pax").addEventListener("input", updateTotal);
        document.getElementById("res-precio-pax").addEventListener("input", updateTotal);

        function toggleRoomField() {
            const origen = document.getElementById("res-origen").value;
            const isVoucher = ['bono', 'smartbox', 'wonderbox', 'ego'].includes(origen);
            const isHotel = origen.includes('hotel');

            document.getElementById("room-group").style.display = (origen === "hotel_inc" || origen === "hotel_no_inc") ? "block" : "none";
            document.getElementById("hotel-group").style.display = (origen === "hotel_inc" || origen === "hotel_no_inc") ? "block" : "none";
            document.getElementById("bono-group").style.display = isVoucher ? "block" : "none";
            document.getElementById("sessions-group").style.display = (origen === "bono") ? "block" : "none";

            // Si es bono, ocultar teléfono (ya está en el bono)
            document.getElementById("tel-group").style.display = (origen === "bono") ? "none" : "block";

            // Campos requeridos dinámicamente (solo si están visibles)
            document.getElementById("res-hotel").required = (document.getElementById("hotel-group").style.display !== 'none');
            document.getElementById("res-hab").required = (document.getElementById("room-group").style.display !== 'none');
            document.getElementById("res-bono").required = (document.getElementById("bono-group").style.display !== 'none');
            document.getElementById("res-tel").required = (document.getElementById("tel-group").style.display !== 'none');

            // Mostrar/Ocultar precios si es incluido o bono
            const isIncluded = (origen === 'hotel_inc' || isVoucher);
            const pricePaxInput = document.getElementById("res-precio-pax");

            if (pricePaxInput) {
                const priceGroup = pricePaxInput.parentElement;
                if (isIncluded) {
                    priceGroup.style.opacity = "0.3";
                    priceGroup.style.pointerEvents = "none";
                    pricePaxInput.required = false;
                    pricePaxInput.value = 0;
                } else {
                    priceGroup.style.opacity = "1";
                    priceGroup.style.pointerEvents = "all";
                    pricePaxInput.required = true;
                }
            }

            updateTotal();
        }

        function showBookingForm() {
            if (!selectedTime) return;

            const dateStr = document.getElementById("main-date-picker").value;
            const isBlocked = (spaConfig.blockedSlots && spaConfig.blockedSlots[dateStr] && spaConfig.blockedSlots[dateStr].includes(selectedTime));

            if (isBlocked) {
                alert("Este turno está CERRADO manualmente. Ábrelo para añadir reservas.");
                return;
            }

            const paxActual = currentData.filter(r => r.hora === selectedTime && r.status !== 'anulada').reduce((s, r) => s + r.pax, 0);
            const maxCapacity = spaConfig.capacity || 20;

            if (paxActual >= maxCapacity) {
                alert("Este turno está completo.");
                return;
            }

            document.getElementById("modal-title").textContent = "Nueva Reserva";
            document.getElementById("modal-subtitle").textContent = `Turno: ${selectedTime}h - Disponibles: ${maxCapacity - paxActual} plazas`;
            document.getElementById("res-id-display").textContent = "NUEVA";
            document.getElementById("audit-info").innerHTML = "";
            document.getElementById("form-id").value = "";
            document.getElementById("btn-cancelar").style.display = "none";
            document.getElementById("form-date").value = document.getElementById("main-date-picker").value;
            document.getElementById("form-time").value = selectedTime;

            // Re-setup form classes
            // document.getElementById("booking-form").className = "form-grid-premium"; // Removed because we use inline styles for the modern wide layout

            // Reset fields
            document.getElementById("res-nombre").value = "";
            document.getElementById("res-tel").value = "";
            document.getElementById("res-origen").value = "particular";
            document.getElementById("res-hotel").value = "Cumbria";
            document.getElementById("res-hab").value = "";
            document.getElementById("res-bono").value = "";
            document.getElementById("res-pax").value = 2;
            document.getElementById("res-precio-pax").value = 0;
            document.getElementById("res-total-text").textContent = "0.00 €";
            document.getElementById("res-obs").value = "";
            document.getElementById("res-servicio").value = "Circuito Spa";
            document.getElementById("res-sesiones").value = 1; // Default for sessions

            // AUTO-RELLENAR SI HAY BONO PENDIENTE
            const pending = sessionStorage.getItem('pendingVoucherBooking');
            if (pending) {
                const data = JSON.parse(pending);
                document.getElementById("res-nombre").value = data.cliente;
                document.getElementById("res-origen").value = "bono";
                document.getElementById("res-bono").value = data.bono || "";
                document.getElementById("res-obs").value = `Reserva de bono: ${data.producto}`;

                // Calcular sesiones por defecto según pax/sesión del bono (mínimo 1)
                const pax = parseInt(document.getElementById("res-pax").value) || 1;
                const paxPerSession = data.pax_por_sesion || 1;
                document.getElementById("res-sesiones").value = Math.ceil(pax / paxPerSession);

                toggleRoomField(); // Update fields visibility based on new origin
            }

            toggleRoomField();
            updatePriceAutomation();

            // Habilitar todo (por si estaba bloqueado por una reserva pasada)
            const formInputs = document.getElementById("booking-form").querySelectorAll("input, select, textarea");
            formInputs.forEach(input => input.disabled = false);
            document.querySelector("#booking-form button[type='submit']").style.display = "block";

            document.getElementById("booking-modal").style.display = "flex";

            // Trigger balance check if coming from dashboard
            if (pending) {
                const data = JSON.parse(pending);
                validateBonoBalance(data.bono);
            }
        }

        function clearPendingVoucher() {
            sessionStorage.removeItem('pendingVoucherBooking');
            const notice = document.getElementById("v-booking-notice");
            if (notice) notice.remove();
        }

        function editBooking(id) {
            const res = currentData.find(r => r.id === id);
            if (!res) return;

            const isAnulada = res.status === 'anulada';
            const btnCancel = document.getElementById("btn-cancelar");
            btnCancel.style.display = isAnulada ? "none" : "block";

            document.getElementById("res-id-display").textContent = res.res_id || "SIN ID";
            document.getElementById("form-id").value = id;
            document.getElementById("form-date").value = res.fecha;
            document.getElementById("form-time").value = res.hora;

            // Verificar si la reserva es PASADA
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();

            const [resHour, resMin] = res.hora.split(':').map(Number);

            let isPast = false;
            if (res.fecha < todayStr) {
                isPast = true;
            } else if (res.fecha === todayStr) {
                // Si es hoy, miramos si la hora ya pasó (margen de 15 min por si acaso)
                if (currentHour > resHour || (currentHour === resHour && currentMin > resMin)) {
                    isPast = true;
                }
            }

            // Bloquear si es pasada
            const formInputs = document.getElementById("booking-form").querySelectorAll("input, select, textarea");
            const btnSave = document.querySelector("#booking-form button[type='submit']");

            if (isPast) {
                document.getElementById("modal-title").innerHTML = '<i class="fas fa-lock" style="color:#ff5252"></i> Reserva Pasada (Solo Lectura)';
                formInputs.forEach(input => input.disabled = true);
                btnSave.style.display = "none";
                btnCancel.style.display = "none";
            } else {
                document.getElementById("modal-title").textContent = "Editar Reserva";
                formInputs.forEach(input => input.disabled = false);
                btnSave.style.display = "block";
                // btnCancel ya se maneja por su status
            }

            // Audit Info
            let auditHtml = "";
            if (res.created_at) auditHtml += `Creada: ${formatDateTime(res.created_at)}<br>`;
            if (res.updated_at) auditHtml += `Modificada: ${formatDateTime(res.updated_at)}`;
            if (res.cancelled_at && res.status === 'anulada') auditHtml += `<br>Anulada: ${formatDateTime(res.cancelled_at)}`;
            document.getElementById("audit-info").innerHTML = auditHtml;

            document.getElementById("res-nombre").value = res.nombre;

            // Formatear teléfono al cargar (3x3)
            let rawTel = (res.tel || "").replace(/\D/g, "");
            let formattedTel = "";
            for (let i = 0; i < rawTel.length; i++) {
                if (i > 0 && i % 3 === 0) formattedTel += " ";
                formattedTel += rawTel[i];
            }
            document.getElementById("res-tel").value = formattedTel;

            document.getElementById("res-origen").value = res.origen || "particular";
            document.getElementById("res-hotel").value = res.hotel || "Cumbria";
            document.getElementById("res-hab").value = res.hab || "";
            document.getElementById("res-bono").value = res.bono || "";
            document.getElementById("res-pax").value = res.pax;
            document.getElementById("res-precio-pax").value = res.precio_pax || (res.precio ? (res.precio / res.pax).toFixed(2) : 0);
            const total = res.precio_total || res.precio || 0;
            document.getElementById("res-precio-total").value = total;
            document.getElementById("res-total-text").textContent = parseFloat(total).toFixed(2) + " €";
            document.getElementById("res-obs").value = res.obs || "";
            document.getElementById("res-servicio").value = res.servicio || "Circuito Spa";
            document.getElementById("res-sesiones").value = res.sesiones_consumidas || 1; // Load sessions consumed

            toggleRoomField();
            document.getElementById("booking-modal").style.display = "flex";

            // Trigger balance check if it's a bono
            if (res.origen === 'bono' && res.bono) {
                validateBonoBalance(res.bono, id);
            }
        }

        async function cancelBookingFromModal() {
            const id = document.getElementById("form-id").value;
            if (!id) return;
            if (!confirm("¿Seguro que deseas ANULAR esta reserva? No se borrará de la base de datos.")) return;

            try {
                const resData = currentData.find(r => r.id === id);
                if (!resData) throw new Error("No se encontró la reserva en memoria.");

                await db.collection("reservas_spa").doc(id).update({
                    status: 'anulada',
                    cancelled_at: new Date().toISOString()
                });

                // REEMBOLSO DE SESIONES SI ES BONO
                if (resData.origen === 'bono' && resData.bono) {
                    const vDoc = await db.collection("spa_vouchers").doc(resData.bono).get();
                    if (vDoc.exists) {
                        const vData = vDoc.data();
                        const used = vData.sesiones_usadas || 0;
                        const refund = resData.sesiones_consumidas || 1;
                        const total = vData.sesiones_totales || 1;

                        const newUsed = Math.max(0, used - refund);
                        let newEstado = 'partially';
                        if (newUsed === 0) newEstado = 'pending';
                        if (vData.estado === 'expired') newEstado = 'expired';

                        await db.collection("spa_vouchers").doc(resData.bono).update({
                            sesiones_usadas: newUsed,
                            estado: newEstado,
                            last_updated: new Date().toISOString(),
                            manual_update: true
                        });
                        console.log(`Reembolso procesado: ${newUsed}/${total} sesiones.`);
                    }
                }

                closeModal();
                loadReservas(document.getElementById("main-date-picker").value);
            } catch (err) { alert("Error al anular: " + err.message); }
        }

        // deleteBooking se mantiene por si fuera necesario borrar físicamente (solo admin manual)
        async function deleteBooking(id) {
            if (!confirm("¿BORRAR PERMANENTEMENTE? Esta acción no se puede deshacer.")) return;
            try {
                await db.collection("reservas_spa").doc(id).delete();
                loadReservas(document.getElementById("main-date-picker").value);
            } catch (err) { alert(err.message); }
        }

        function closeModal() {
            document.getElementById("booking-modal").style.display = "none";
        }

        document.getElementById("booking-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("form-id").value;
            const date = document.getElementById("form-date").value;
            const time = document.getElementById("form-time").value;
            const pax = parseInt(document.getElementById("res-pax").value);
            const sesionesConsumidas = parseInt(document.getElementById("res-sesiones").value) || 1;
            const duration = parseInt(document.getElementById("inputDuration")?.value || 60);

            // 1. VALIDACIÓNES AVANZADAS (Solo Timeline / Módulos Privados)
            if (currentModule.isPrivate) {
                // Check Sala
                const roomFree = await checkRoomAvailability(date, time, duration, id); // id is null on create, checkRoom handles it
                if (!roomFree) {
                    alert(`¡SALA OCUPADA! Ya existe una reserva en este rango de horario (${time} + ${duration}min).`);
                    return;
                }

                // Check Personal
                const staffFree = await checkStaffAvailability(date, time, duration, id);
                if (!staffFree) {
                    alert(`¡SIN PERSONAL DISPONIBLE! No hay terapeutas libres para este horario. Revisa la configuración en Gestión de Personal.`);
                    return;
                }
            }

            // Validar capacidad (solo confirmadas) - MANTENEMOS LOGICA ORIGINAL PARA SPA GENERAL
            if (!currentModule.isPrivate) {
                const totalOtros = currentData
                    .filter(r => r.hora === time && r.id !== id && r.status !== 'anulada')
                    .reduce((s, r) => s + (r.pax || 0), 0);

                const maxCapacity = spaConfig.capacity || 20;

                if (totalOtros + pax > maxCapacity) {
                    const proceed = confirm(`¡Exceso de aforo! Solo quedan ${maxCapacity - totalOtros} plazas libres.\n\n¿Deseas confirmar la reserva de todas formas?`);
                    if (!proceed) return;
                }
            }

            // VALIDACIÓN EXTRA DE BONO (Límite de sesiones)
            if (document.getElementById("res-origen").value === 'bono') {
                const bonoId = document.getElementById("res-bono").value.trim();
                const sesionesInput = document.getElementById("res-sesiones");
                const maxAllowed = parseInt(sesionesInput.getAttribute("max"));

                if (!isNaN(maxAllowed) && sesionesConsumidas > maxAllowed) {
                    alert(`¡LIMITE EXCEDIDO! Este bono solo tiene ${maxAllowed} sesiones disponibles.`);
                    sesionesInput.focus();
                    return;
                }
            }

            const payload = {
                nombre: document.getElementById("res-nombre").value,
                tel: document.getElementById("res-tel").value,
                origen: document.getElementById("res-origen").value,
                hotel: document.getElementById("res-hotel").value,
                hab: document.getElementById("res-hab").value,
                bono: document.getElementById("res-bono").value,
                fecha: date,
                hora: time,
                pax: pax,
                sesiones_consumidas: sesionesConsumidas, // Save sessions consumed
                precio_pax: parseFloat(document.getElementById("res-precio-pax").value) || 0,
                precio_total: parseFloat(document.getElementById("res-precio-total").value) || 0,
                servicio: document.getElementById("res-servicio").value,
                duracion: duration, // Campo nuevo
                obs: document.getElementById("res-obs").value,
                updated_at: new Date().toISOString()
            };

            try {
                if (id) {
                    await db.collection(currentModule.collection).doc(id).update(payload);
                    showToast("Reserva actualizada", "success");
                } else {
                    payload.res_id = generateUID();
                    payload.status = 'confirmada';
                    payload.created_at = new Date().toISOString();
                    const docRef = await db.collection(currentModule.collection).add(payload);
                    showToast("Reserva creada correctamente", "success");

                    // Si se creó desde un bono pendiente, limparlo
                    if (sessionStorage.getItem('pendingVoucherBooking')) {
                        clearPendingVoucher();
                    }

                    // SI ES UN BONO, ACTUALIZAR SESIONES USADAS
                    if (payload.origen === 'bono' && payload.bono) {
                        try {
                            const vDoc = await db.collection("spa_vouchers").doc(payload.bono).get();
                            if (vDoc.exists) {
                                const vData = vDoc.data();
                                const usedSessions = vData.sesiones_usadas || 0;
                                const paxPerSession = vData.pax_por_sesion || 1;
                                const totalSessions = vData.sesiones_totales || 1;

                                // Usar el valor manual del formulario si existe, sino calcular
                                const manualSessions = parseInt(document.getElementById("res-sesiones").value);
                                const consumed = !isNaN(manualSessions) ? manualSessions : Math.ceil(payload.pax / paxPerSession);

                                const newUsed = usedSessions + consumed;

                                const update = {
                                    sesiones_usadas: newUsed,
                                    last_updated: new Date().toISOString(),
                                    manual_update: true
                                };

                                if (newUsed >= totalSessions) {
                                    update.estado = 'completed';
                                } else {
                                    update.estado = 'partially';
                                }

                                await db.collection("spa_vouchers").doc(payload.bono).update(update);
                                console.log(`Bono actualizado: ${newUsed}/${totalSessions} sesiones.`);
                            }
                        } catch (vErr) {
                            console.warn("No se pudo actualizar el estado del bono:", vErr);
                        }
                    }
                }

                // Limpiar bono pendiente si existía
                clearPendingVoucher();

                closeModal();
                loadReservas(date);
            } catch (err) { alert(err.message); }
        });

        // ------------------- TIMELINE & LOGICA NOVEDOSA -------------------

        function renderTimeline(dateString) {
            const container = document.getElementById("slots-container");
            container.innerHTML = "";
            const dateBlockedSlots = (spaConfig.blockedSlots && spaConfig.blockedSlots[dateString]) || [];

            // Generar horas de 10:00 a 22:00
            for (let h = 10; h < 22; h++) {
                const hourLabel = `${h.toString().padStart(2, '0')}:00`;
                const row = document.createElement("div");
                row.className = "timeline-row";
                row.style.borderBottom = "1px solid var(--border)";
                row.style.minHeight = "60px";
                row.style.display = "flex";
                row.style.alignItems = "flex-start";
                row.style.padding = "10px";
                row.style.position = "relative";

                // Etiqueta de hora
                const label = document.createElement("div");
                label.style.width = "60px";
                label.style.fontWeight = "bold";
                label.style.color = "var(--text-muted)";
                label.textContent = hourLabel;
                row.appendChild(label);

                // Área de contenido
                const content = document.createElement("div");
                content.style.flex = "1";
                content.style.position = "relative";

                // Botón + para añadir reserva en esta hora
                const addBtn = document.createElement("button");
                addBtn.className = "btn-slot available";
                addBtn.style.width = "auto";
                addBtn.style.padding = "5px 15px";
                addBtn.style.fontSize = "0.9rem";
                addBtn.innerHTML = "<i class='fas fa-plus'></i> Reservar";
                addBtn.onclick = () => selectSlot(hourLabel, false, false); // Slot por defecto, duración a elegir en modal

                // Buscar reservas que COMIENZEN en esta hora (simple view)
                // Para una vista real tipo Gantt requeriría más CSS absoluto, pero esto es funcional
                const bookingsInHour = currentData.filter(r => r.hora.startsWith(hourLabel.substring(0, 2))); // Ej: "10:00", "10:30"

                if (bookingsInHour.length > 0) {
                    bookingsInHour.forEach(booking => {
                        const card = createBookingCardTimeline(booking);
                        content.appendChild(card);
                    });
                    // Ocultar botón si ta ocupado (simplificación, idealmente checkear hueco)
                    if (bookingsInHour.some(b => b.status === 'confirmada')) addBtn.style.display = 'none';
                }

                content.appendChild(addBtn);
                row.appendChild(content);
                container.appendChild(row);
            }
        }

        function createBookingCardTimeline(booking) {
            const div = document.createElement("div");
            div.className = "booking-card";
            div.innerHTML = `
                <div style="font-weight:600">${booking.cliente}</div>
                <div style="font-size:0.85rem">${booking.servicio} (${booking.duracion || 60} min)</div>
                <div style="font-size:0.8rem; margin-top:5px">
                    <button onclick="editBooking('${booking.id}')" class="btn-xs"><i class="fas fa-edit"></i></button>
                    ${booking.tel ? `<a href="tel:${booking.tel}" class="btn-xs"><i class="fas fa-phone"></i></a>` : ''}
                </div>
            `;
            // Color según estado
            div.style.background = booking.status === 'confirmada' ? 'rgba(76, 175, 80, 0.2)' : 'rgba(244, 67, 54, 0.2)';
            div.style.borderLeft = booking.status === 'confirmada' ? '4px solid var(--success)' : '4px solid var(--danger)';
            div.style.padding = "8px";
            div.style.marginBottom = "5px";
            return div;
        }

        // --- VALIDACIONES AVANZADAS ---

        async function checkRoomAvailability(date, start, duration, excludeId = null) {
            // Calcular fin
            const [h, m] = start.split(':').map(Number);
            const startMin = h * 60 + m;
            const endMin = startMin + parseInt(duration);

            // Fetch booking de este módulo y día si no están ya en currentData (ya están)
            const colliding = currentData.some(b => {
                if (b.id === excludeId) return false;
                if (b.status === 'anulada') return false;

                const [bh, bm] = b.hora.split(':').map(Number);
                const bStart = bh * 60 + bm;
                const bDuration = parseInt(b.duracion || 60);
                const bEnd = bStart + bDuration;

                // Check overlap
                return (startMin < bEnd && endMin > bStart);
            });

            return !colliding;
        }

        async function checkStaffAvailability(date, start, duration, excludeId = null) {
            if (!currentModule.requiresStaff) return true; // Suite no consume

            const [h, m] = start.split(':').map(Number);
            const startMin = h * 60 + m; // Minutos desde 00:00 (ej: 10:00 = 600)
            const endMin = startMin + parseInt(duration);

            // Determinar turno (Mañana < 16:00, Tarde >= 16:00)
            // Usamos starttime para definir turno principal
            const staffLimit = (h < 16) ? staffConfig.morning : staffConfig.afternoon;

            // Consultar reservas activas en OTROS módulos que consumen personal (Panacea, VIP)
            // (Idealmente esto sería una Cloud Function para ser atómico, pero haremos client-side check)

            let activeStaffBookings = 0;

            // Array de colecciones que consumen personal
            const staffCollections = ['reservas_panacea', 'reservas_vip', 'reservas_peluqueria']; // Agregar masajes si hubiera

            for (const col of staffCollections) {
                const snapshot = await db.collection(col).where("fecha", "==", date).get();
                snapshot.forEach(doc => {
                    if (doc.id === excludeId) return; // Propia reserva editándose
                    const data = doc.data();
                    if (data.status === 'anulada') return;

                    const [bh, bm] = data.hora.split(':').map(Number);
                    const bStart = bh * 60 + bm;
                    const bDuration = parseInt(data.duracion || 60);
                    const bEnd = bStart + bDuration;

                    // Overlap check
                    if (startMin < bEnd && endMin > bStart) {
                        activeStaffBookings++;
                    }
                });
            }

            console.log(`Staff Check: ${activeStaffBookings} activos vs Limite ${staffLimit}`);
            return activeStaffBookings < staffLimit;
        }

        // Inject in window for debugging
        window.loadStaffConfig = loadStaffConfig;

        // ------------------------- FIN NUEVA LÓGICA -------------------------
    </script>
</body>

</html>