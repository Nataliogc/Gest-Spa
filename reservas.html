<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas Spa - Zenith Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .slot-card {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }

        .slot-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-color: var(--accent);
        }

        .slot-card.full {
            opacity: 0.7;
            background: #fdf2f2;
            cursor: not-allowed;
            border-color: #ff5252;
        }

        .slot-card.full:hover {
            transform: none;
            box-shadow: none;
        }

        .pax-badge {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .time-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .progress-mini {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s;
        }

        .grid-7 {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        /* Highlight for current slot */
        .slot-card.active {
            box-shadow: 0 0 0 2px var(--accent);
            background: rgba(212, 175, 55, 0.05);
        }

        .badge-particular {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-hotel-inc {
            background: #e3f2fd;
            color: #1565c0;
        }

        .badge-hotel-no {
            background: #fff3e0;
            color: #ef6c00;
        }

        .badge-bono {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-smartbox {
            background: #fffde7;
            color: #fbc02d;
        }

        .badge-wonderbox {
            background: #fce4ec;
            color: #c2185b;
        }

        .badge-ego {
            background: #e0f2f1;
            color: #00796b;
        }

        .badge-anulada {
            background: #ffebee;
            color: #d32f2f;
        }

        .badge {
            display: inline-block;
            white-space: nowrap;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        /* Premium Modal Styles */
        .modal-header-premium {
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .res-id-badge {
            font-size: 0.65rem;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
            color: #666;
            font-weight: 700;
        }

        .form-section-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid-premium {
            display: grid;
            gap: 20px;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #ccc;
            font-size: 0.8rem;
        }

        .input-with-icon input,
        .input-with-icon select,
        .textarea-premium {
            padding-left: 35px !important;
        }

        tr.cancelled-row {
            opacity: 0.5;
            background: #fafafa;
            text-decoration: line-through;
            color: #999;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            background: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .switch-container:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .badge {
            display: inline-block;
            white-space: nowrap;
        }

        /* Tooltip Premium */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 100;
            bottom: 150%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.75rem;
            line-height: 1.4;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            bottom: 125%;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-container" style="margin-bottom: 30px;">
            <h1 style="font-size: 1.4rem; font-weight: 300; letter-spacing: 3px;">ZENITH</h1>
            <span
                style="font-size: 0.65rem; letter-spacing: 2px; color: var(--accent); font-weight: 600;">MANAGER</span>
        </div>

        <nav class="nav-menu">
            <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="reservas.html" class="nav-link active"><i class="fas fa-calendar-alt"></i> Reservas Spa</a>
            <a href="catalogo.html" class="nav-link"><i class="fas fa-list"></i> Catálogo</a>
        </nav>

        <div class="sidebar-footer" style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
            <div style="background: #fff9e6; padding: 12px; border-radius: 10px; border: 1px solid #ffeeba;">
                <h4 style="font-size: 0.7rem; color: #856404; margin-bottom: 8px; text-transform: uppercase;">
                    <i class="fas fa-bullhorn"></i> Protocolo
                </h4>
                <ul
                    style="list-style: none; padding: 0; margin: 0; font-size: 0.65rem; color: #856404; line-height: 1.4;">
                    <li>• Gorro y Chanclas <strong>Obligatorios</strong></li>
                    <li>• Toallas Incluidas</li>
                    <li>• Validar <strong>Bono Físico</strong></li>
                </ul>
            </div>
        </div>
    </aside>

    <main class="main-content" style="margin-left: 210px; width: calc(100% - 210px); padding: 10px 20px;">
        <header class="header-flex" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h2 style="font-weight: 300; letter-spacing: 2px; margin: 0; font-size: 1.3rem;">PANEL DE TURNOS</h2>
                <input type="date" id="main-date-picker" class="param-input" style="width: 180px; padding: 8px 12px;">

                <label class="switch-container">
                    <input type="checkbox" id="show-cancelled"
                        onchange="loadReservas(document.getElementById('main-date-picker').value)"
                        style="width: 14px; height: 14px; cursor:pointer;">
                    Ver Anuladas
                </label>
            </div>
            <div id="status-legend" style="display: flex; gap: 15px; font-size: 0.7rem; color: var(--text-muted);">
                <span><i class="fas fa-circle" style="color: #4caf50;"></i> Libre</span>
                <span><i class="fas fa-circle" style="color: #ff9800;"></i> Casi lleno</span>
                <span><i class="fas fa-circle" style="color: #f44336;"></i> Completo</span>
            </div>
        </header>

        <!-- Dynamic Grid of Slots -->
        <div id="slots-container" class="grid-7">
            <!-- Rendered by JS -->
        </div>

        <!-- Hourly Details / Selected Slot -->
        <div id="details-section" style="margin-top: 25px; display: none;">
            <div class="stat-card" style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="details-title" style="font-size: 1rem; font-weight: 600;">Reservas para las 10:00h</h3>
                    <button class="btn btn-accent btn-sm" onclick="showBookingForm()">
                        <i class="fas fa-plus"></i> Añadir Reserva
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente / Tel</th>
                                <th>Origen</th>
                                <th>Hab</th>
                                <th>Pax</th>
                                <th>Precio/Pax</th>
                                <th>Total</th>
                                <th>Obs</th>
                                <th style="text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="details-table-body">
                            <!-- Filled dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL RESERVA REDESIGN -->
    <div id="booking-modal" class="modal">
        <div class="modal-content" style="max-width: 820px; padding: 20px 25px;">
            <span class="close-modal" onclick="closeModal()">&times;</span>

            <div class="modal-header-premium" style="margin-bottom: 15px; padding-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h2 id="modal-title" style="margin:0; font-size: 1.25rem;">Alta de Reserva</h2>
                        <p id="modal-subtitle" style="font-size: 0.75rem; color: var(--text-muted); margin: 2px 0 0 0;">
                        </p>
                    </div>
                    <div style="text-align: right; min-width: 200px;">
                        <span id="res-id-display" class="res-id-badge">NUEVA</span>
                        <div id="audit-info"
                            style="font-size: 0.62rem; color: #999; margin-top: 5px; line-height: 1.3;"></div>
                    </div>
                </div>
            </div>

            <form id="booking-form" class="form-grid-premium" style="gap: 15px;">
                <input type="hidden" id="form-id">
                <input type="hidden" id="form-date">
                <input type="hidden" id="form-time">

                <!-- Fila 1: Cliente y Pax -->
                <div id="client-row" style="display: grid; grid-template-columns: 2fr 1.2fr 0.8fr; gap: 15px;">
                    <div class="form-group">
                        <div class="form-section-label"><i class="fas fa-user-circle"></i> Cliente</div>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="res-nombre" required placeholder="Nombre completo">
                        </div>
                    </div>
                    <div class="form-group" id="tel-group">
                        <div class="form-section-label"><i class="fas fa-phone"></i> Teléfono</div>
                        <div class="input-with-icon">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="res-tel" required placeholder="XXX XXX XXX"
                                pattern="\d{3} \d{3} \d{3}" minlength="11" maxlength="11"
                                title="Debe introducir exactamente 9 números (formato: 000 000 000)">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-section-label"><i class="fas fa-users"></i> Pax</div>
                        <div class="input-with-icon">
                            <i class="fas fa-user-friends"></i>
                            <input type="number" id="res-pax" value="2" min="1" max="25" step="1" required>
                        </div>
                    </div>
                </div>

                <!-- Sección 2: Estancia / Bono -->
                <div class="form-group">
                    <div class="form-section-label"><i class="fas fa-map-marker-alt"></i> Origen y Ubicación</div>
                    <div id="origin-row" style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                        <div class="input-with-icon">
                            <i class="fas fa-tag"></i>
                            <select id="res-origen" onchange="toggleRoomField()">
                                <option value="particular">Particular (Pago)</option>
                                <option value="hotel_inc">Hotel - Incluido</option>
                                <option value="hotel_no_inc">Hotel - NO Incluidos</option>
                                <option value="bono">Bono Spa (Interno)</option>
                                <option value="smartbox">Smartbox</option>
                                <option value="wonderbox">Wonderbox</option>
                                <option value="ego">Ego Experiencias</option>
                            </select>
                        </div>
                        <div class="input-with-icon" id="hotel-group" style="display:none">
                            <i class="fas fa-hotel"></i>
                            <select id="res-hotel">
                                <option value="Cumbria">Cumbria</option>
                                <option value="Guadiana">Guadiana</option>
                            </select>
                        </div>
                        <div class="input-with-icon" id="room-group" style="display:none">
                            <i class="fas fa-door-open"></i>
                            <input type="text" id="res-hab" placeholder="Habitación">
                        </div>
                        <div class="input-with-icon" id="bono-group" style="display:none">
                            <i class="fas fa-ticket-alt"></i>
                            <input type="text" id="res-bono" placeholder="ID del bono">
                        </div>
                    </div>
                </div>

                <!-- Fila 3: Observaciones y Precios (Lado a Lado) -->
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <div class="form-section-label"><i class="fas fa-comment-dots"></i> Observaciones</div>
                        <textarea id="res-obs" placeholder="Notas adicionales, alergias..." rows="1"
                            style="width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); font-family: inherit; font-size: 0.85rem; height: 55px; resize: none;"></textarea>
                    </div>

                    <div class="form-group" id="pricing-fields-container">
                        <div class="form-section-label"><i class="fas fa-euro-sign"></i> Tarifas</div>
                        <div id="pax-price-row" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            <div id="pricing-fields" style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="input-with-icon">
                                    <i class="fas fa-user-tag"></i>
                                    <input type="number" id="res-precio-pax" step="0.01" value="0" required
                                        placeholder="Precio/Pax">
                                </div>
                                <div id="total-display-container"
                                    style="background: rgba(212, 175, 55, 0.08); padding: 12px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.2); display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-calculator" style="color: var(--accent);"></i>
                                    <span
                                        style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Total:</span>
                                    <span id="res-total-text"
                                        style="font-size: 1.1rem; font-weight: 700; color: var(--accent);">0.00 €</span>
                                    <input type="hidden" id="res-precio-total" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions" style="margin-top: 5px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-accent"
                        style="flex: 1.2; height: 42px; font-weight: 700; font-size: 0.9rem;">
                        <i class="fas fa-check-circle"></i> CONFIRMAR RESERVA
                    </button>
                    <button type="button" class="btn btn-outline" style="flex: 0.8; height: 42px; font-size: 0.85rem;"
                        onclick="closeModal()">
                        <i class="fas fa-times-circle"></i> SALIR
                    </button>
                    <button type="button" id="btn-cancelar" class="btn btn-outline"
                        style="flex: 0.5; border-color: #ff5252; color: #ff5252; display: none; height: 42px; font-size: 0.85rem;"
                        onclick="cancelBookingFromModal()">
                        <i class="fas fa-ban"></i> ANULAR
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const db = firebase.firestore();
        const SLOTS_WEEK = ["10:00", "11:00", "12:15", "13:30", "15:45", "16:45", "18:00", "19:00", "20:30"];
        const SLOTS_SUN = ["10:00", "11:00", "12:15", "13:30"];

        function formatDateTime(isoStr) {
            if (!isoStr) return "";
            const d = new Date(isoStr);
            return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                ' ' + d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        let currentData = [];
        let selectedTime = null;
        let baseCircuitoPrice = 0;

        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date().toISOString().split('T')[0];
            const picker = document.getElementById("main-date-picker");
            picker.value = today;

            fetchBasePrice();
            picker.addEventListener("change", () => loadReservas(picker.value));
            loadReservas(today);

            // Price automation listeners
            document.getElementById("res-origen").addEventListener("change", updatePriceAutomation);
            document.getElementById("res-pax").addEventListener("input", updatePriceAutomation);
            document.getElementById("res-precio-pax").addEventListener("input", () => {
                const pax = parseInt(document.getElementById("res-pax").value) || 1;
                const pPax = parseFloat(document.getElementById("res-precio-pax").value) || 0;
                const total = pPax * pax;
                document.getElementById("res-precio-total").value = total.toFixed(2);
                document.getElementById("res-total-text").textContent = total.toFixed(2) + " €";
            });

            // Formatear teléfono: 3 bloques de 3 números (XXX XXX XXX)
            document.getElementById("res-tel").addEventListener("input", (e) => {
                let value = e.target.value.replace(/\D/g, ""); // Solo números
                if (value.length > 9) value = value.slice(0, 9); // Límite de 9

                let formattedValue = "";
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 3 === 0) formattedValue += " ";
                    formattedValue += value[i];
                }
                e.target.value = formattedValue;
            });
        });

        function generateUID() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let res = '';
            for (let i = 0; i < 4; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return `RS-${res}`;
        }

        async function fetchBasePrice() {
            try {
                // Buscamos el servicio "Circuito SPA" para sacar su precio base
                const snapshot = await db.collection("spa_services")
                    .where("nombre", ">=", "Circuito")
                    .get();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nombre.toLowerCase().includes("circuito spa") || data.nombre.toLowerCase() === "circuito") {
                        baseCircuitoPrice = parseFloat(data.precio) || 0;
                        console.log("Precio base detectado:", baseCircuitoPrice);
                    }
                });

                if (baseCircuitoPrice === 0) {
                    // Fallback si no se encuentra
                    baseCircuitoPrice = 30; // Precio por defecto razonable
                }
            } catch (err) {
                console.error("Error fetching price:", err);
                baseCircuitoPrice = 30;
            }
        }

        function updatePriceAutomation() {
            const origen = document.getElementById("res-origen").value;
            const pax = parseInt(document.getElementById("res-pax").value) || 1;
            const pricePaxInput = document.getElementById("res-precio-pax");
            const priceTotalInput = document.getElementById("res-precio-total");

            if (origen === 'particular' || origen === 'hotel_no_inc') {
                const total = baseCircuitoPrice * pax;
                pricePaxInput.value = baseCircuitoPrice.toFixed(2);
                priceTotalInput.value = total.toFixed(2);
                document.getElementById("res-total-text").textContent = total.toFixed(2) + " €";
            } else {
                pricePaxInput.value = (0).toFixed(2);
                priceTotalInput.value = (0).toFixed(2);
                document.getElementById("res-total-text").textContent = "0.00 €";
            }
        }

        async function loadReservas(date) {
            try {
                const snapshot = await db.collection("reservas_spa")
                    .where("fecha", "==", date)
                    .get();

                currentData = [];
                snapshot.forEach(doc => currentData.push({ id: doc.id, ...doc.data() }));

                renderSlots(date);
                if (selectedTime) updateDetails(selectedTime);
            } catch (err) {
                console.error("Error:", err);
            }
        }

        function renderSlots(dateString) {
            const date = new Date(dateString);
            const isSunday = date.getDay() === 0;
            const slots = isSunday ? SLOTS_SUN : SLOTS_WEEK;
            const container = document.getElementById("slots-container");

            container.innerHTML = slots.map(time => {
                const dayReservations = currentData.filter(r => r.hora === time && r.status !== 'anulada');
                const paxTotal = dayReservations.reduce((sum, r) => sum + (r.pax || 0), 0);
                const isFull = paxTotal >= 20;

                let color = "#4caf50"; // Green
                if (isFull) color = "#f44336"; // Red
                else if (paxTotal > 15) color = "#ff9800"; // Orange

                const percent = (paxTotal / 20) * 100;

                return `
                    <div class="slot-card ${isFull ? 'full' : ''} ${selectedTime === time ? 'active' : ''}" 
                         onclick="selectSlot('${time}', ${isFull})">
                        <div class="time-label">${time}</div>
                        <div class="pax-badge" style="color: ${color}">${paxTotal}<span style="font-size: 0.8rem; color: #999; font-weight: 400;">/20</span></div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); font-weight: 500;">
                            ${isFull ? 'COMPLETO' : (20 - paxTotal) + ' disponibles'}
                        </div>
                        <div class="progress-mini">
                            <div class="progress-bar" style="width: ${Math.min(percent, 100)}%; background: ${color}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectSlot(time, isFull) {
            selectedTime = time;
            renderSlots(document.getElementById("main-date-picker").value);

            document.getElementById("details-section").style.display = "block";
            document.getElementById("details-title").textContent = `Reservas para las ${time}h`;
            updateDetails(time);
        }

        function updateDetails(time) {
            const showCancelled = document.getElementById("show-cancelled").checked;
            let list = currentData.filter(r => r.hora === time);

            if (!showCancelled) {
                list = list.filter(r => r.status !== 'anulada');
            }

            const body = document.getElementById("details-table-body");

            if (list.length === 0) {
                body.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999; padding: 20px;">No hay reservas para este turno.</td></tr>';
                return;
            }

            body.innerHTML = list.map(res => {
                let badgeClass = "badge-particular";
                let badgeText = "Particular";

                if (res.origen === 'hotel_inc') { badgeClass = "badge-hotel-inc"; badgeText = "Hot. Inc"; }
                else if (res.origen === 'hotel_no_inc') { badgeClass = "badge-hotel-no"; badgeText = "Hot. NO Inc"; }
                else if (res.origen === 'bono') { badgeClass = "badge-bono"; badgeText = "Bono Spa"; }
                else if (res.origen === 'smartbox') { badgeClass = "badge-smartbox"; badgeText = "Smartbox"; }
                else if (res.origen === 'wonderbox') { badgeClass = "badge-wonderbox"; badgeText = "Wonderbox"; }
                else if (res.origen === 'ego') { badgeClass = "badge-ego"; badgeText = "Ego Exp"; }

                const isAnulada = res.status === 'anulada';

                return `
                <tr class="${isAnulada ? 'cancelled-row' : ''}">
                    <td style="font-size: 0.65rem; color: #666; font-weight: 700;">${res.res_id || '-'}</td>
                    <td>
                        <div style="font-weight: 600;">${res.nombre}</div>
                        <div style="font-size: 0.7rem; color: #999;">${res.tel || '-'} ${res.bono ? ' | <i class="fas fa-ticket-alt"></i> ' + res.bono : ''}</div>
                    </td>
                    <td>
                        ${isAnulada ? '<span class="badge badge-anulada">ANULADA</span>' : `<span class="badge ${badgeClass}">${badgeText}</span>`}
                    </td>
                    <td style="font-weight: 600;">
                        ${res.hab ? (res.hotel || 'Cumbria') + ' - ' + res.hab : '-'}
                    </td>
                    <td style="font-weight: 700; color: var(--accent);">${res.pax} pax</td>
                    <td style="font-weight: 600;">${res.precio_pax ? res.precio_pax + '€' : '-'}</td>
                    <td style="font-weight: 700;">${res.precio_total ? res.precio_total + '€' : '0€'}</td>
                    <td style="text-align: center;">
                        ${res.obs ? `
                            <div class="tooltip">
                                <i class="fas fa-comment-dots" style="color: var(--accent);"></i>
                                <span class="tooltiptext"><strong>Observaciones:</strong><br>${res.obs}</span>
                            </div>
                        ` : '-'}
                    </td>
                    <td style="text-align: right;">
                        <button class="btn btn-outline btn-sm" onclick="editBooking('${res.id}')" style="padding: 2px 8px;"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        function toggleRoomField() {
            const origen = document.getElementById("res-origen").value;
            const isVoucher = ['bono', 'smartbox', 'wonderbox', 'ego'].includes(origen);
            const isHotel = origen.includes('hotel');

            document.getElementById("hotel-group").style.display = isHotel ? "block" : "none";
            document.getElementById("room-group").style.display = isHotel ? "block" : "none";
            document.getElementById("bono-group").style.display = isVoucher ? "block" : "none";

            // Campos requeridos dinámicamente
            document.getElementById("res-hotel").required = isHotel;
            document.getElementById("res-hab").required = isHotel;
            document.getElementById("res-bono").required = isVoucher;
            document.getElementById("res-tel").required = !isHotel;

            // Ocultar teléfono si es hotel
            const telGroup = document.getElementById("tel-group");
            const clientRow = document.getElementById("client-row");
            if (telGroup && clientRow) {
                telGroup.style.display = isHotel ? "none" : "block";
                clientRow.style.gridTemplateColumns = isHotel ? "3.2fr 0.8fr" : "2fr 1.2fr 0.8fr";
            }

            // Ocultar bloque de tarifas si está incluido o es un bono
            const isIncluded = (origen === 'hotel_inc' || isVoucher);
            const pricingContainer = document.getElementById("pricing-fields-container");
            const pricePaxInput = document.getElementById("res-precio-pax");

            if (pricingContainer) {
                pricingContainer.style.display = isIncluded ? "none" : "block";
                if (pricePaxInput) pricePaxInput.required = !isIncluded;
            }

            // Cambiar layout de observaciones si no hay precios
            const obsContainer = document.getElementById("res-obs").parentElement.parentElement;
            if (obsContainer) {
                obsContainer.style.gridTemplateColumns = isIncluded ? "1fr" : "1.5fr 1fr";
            }

            // Layout logic based on visible fields
            const originRow = document.getElementById("origin-row");
            if (originRow) {
                if (isHotel) {
                    // If hotel, we have origin + hotel + room (3 fields in second row)
                    originRow.style.gridTemplateColumns = "1fr 1fr 1fr";
                } else if (isVoucher) {
                    // If voucher, we have origin + voucher ID (2 fields)
                    originRow.style.gridTemplateColumns = "1fr 1fr";
                } else {
                    // If particular, just origin (1 field)
                    originRow.style.gridTemplateColumns = "1fr";
                }
            }

            // Si es un canal de bonos, el número de bono es requerido para guardar
            document.getElementById("res-bono").required = isVoucher;
        }

        function showBookingForm() {
            if (!selectedTime) return;
            const paxActual = currentData.filter(r => r.hora === selectedTime && r.status !== 'anulada').reduce((s, r) => s + r.pax, 0);
            if (paxActual >= 20) {
                alert("Este turno está completo.");
                return;
            }

            document.getElementById("modal-title").textContent = "Nueva Reserva";
            document.getElementById("modal-subtitle").textContent = `Turno: ${selectedTime}h - Disponibles: ${20 - paxActual} plazas`;
            document.getElementById("res-id-display").textContent = "NUEVA";
            document.getElementById("audit-info").innerHTML = "";
            document.getElementById("form-id").value = "";
            document.getElementById("btn-cancelar").style.display = "none";
            document.getElementById("form-date").value = document.getElementById("main-date-picker").value;
            document.getElementById("form-time").value = selectedTime;

            // Re-setup form classes
            document.getElementById("booking-form").className = "form-grid-premium";

            // Reset fields
            document.getElementById("res-nombre").value = "";
            document.getElementById("res-tel").value = "";
            document.getElementById("res-origen").value = "particular";
            document.getElementById("res-hotel").value = "Cumbria";
            document.getElementById("res-hab").value = "";
            document.getElementById("res-bono").value = "";
            document.getElementById("res-pax").value = 2;
            document.getElementById("res-precio-pax").value = 0;
            document.getElementById("res-precio-total").value = 0;
            document.getElementById("res-total-text").textContent = "0.00 €";
            document.getElementById("res-obs").value = "";

            toggleRoomField();
            updatePriceAutomation();
            document.getElementById("booking-modal").style.display = "flex";
        }

        function editBooking(id) {
            const res = currentData.find(r => r.id === id);
            if (!res) return;

            document.getElementById("modal-title").textContent = "Editar Reserva";
            document.getElementById("res-id-display").textContent = res.res_id || "SIN ID";
            document.getElementById("form-id").value = id;
            document.getElementById("form-date").value = res.fecha;
            document.getElementById("form-time").value = res.hora;

            // Show cancel button if not already cancelled
            document.getElementById("btn-cancelar").style.display = (res.status === 'anulada') ? "none" : "block";

            // Audit Info
            let auditHtml = "";
            if (res.created_at) auditHtml += `Creada: ${formatDateTime(res.created_at)}<br>`;
            if (res.updated_at) auditHtml += `Modificada: ${formatDateTime(res.updated_at)}`;
            if (res.cancelled_at && res.status === 'anulada') auditHtml += `<br>Anulada: ${formatDateTime(res.cancelled_at)}`;
            document.getElementById("audit-info").innerHTML = auditHtml;

            document.getElementById("res-nombre").value = res.nombre;

            // Formatear teléfono al cargar (3x3)
            let rawTel = (res.tel || "").replace(/\D/g, "");
            let formattedTel = "";
            for (let i = 0; i < rawTel.length; i++) {
                if (i > 0 && i % 3 === 0) formattedTel += " ";
                formattedTel += rawTel[i];
            }
            document.getElementById("res-tel").value = formattedTel;

            document.getElementById("res-origen").value = res.origen || "particular";
            document.getElementById("res-hotel").value = res.hotel || "Cumbria";
            document.getElementById("res-hab").value = res.hab || "";
            document.getElementById("res-bono").value = res.bono || "";
            document.getElementById("res-pax").value = res.pax;
            document.getElementById("res-precio-pax").value = res.precio_pax || (res.precio ? (res.precio / res.pax).toFixed(2) : 0);
            const total = res.precio_total || res.precio || 0;
            document.getElementById("res-precio-total").value = total;
            document.getElementById("res-total-text").textContent = parseFloat(total).toFixed(2) + " €";
            document.getElementById("res-obs").value = res.obs || "";

            toggleRoomField();
            document.getElementById("booking-modal").style.display = "flex";
        }

        async function cancelBookingFromModal() {
            const id = document.getElementById("form-id").value;
            if (!id) return;
            if (!confirm("¿Seguro que deseas ANULAR esta reserva? No se borrará de la base de datos.")) return;

            try {
                await db.collection("reservas_spa").doc(id).update({
                    status: 'anulada',
                    cancelled_at: new Date().toISOString()
                });
                closeModal();
                loadReservas(document.getElementById("main-date-picker").value);
            } catch (err) { alert(err.message); }
        }

        // deleteBooking se mantiene por si fuera necesario borrar físicamente (solo admin manual)
        async function deleteBooking(id) {
            if (!confirm("¿BORRAR PERMANENTEMENTE? Esta acción no se puede deshacer.")) return;
            try {
                await db.collection("reservas_spa").doc(id).delete();
                loadReservas(document.getElementById("main-date-picker").value);
            } catch (err) { alert(err.message); }
        }

        function closeModal() {
            document.getElementById("booking-modal").style.display = "none";
        }

        document.getElementById("booking-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("form-id").value;
            const date = document.getElementById("form-date").value;
            const time = document.getElementById("form-time").value;
            const pax = parseInt(document.getElementById("res-pax").value);

            // Validar capacidad (solo confirmadas)
            const totalOtros = currentData
                .filter(r => r.hora === time && r.id !== id && r.status !== 'anulada')
                .reduce((s, r) => s + (r.pax || 0), 0);

            if (totalOtros + pax > 20) {
                const proceed = confirm(`¡Exceso de aforo! Solo quedan ${20 - totalOtros} plazas libres.\n\n¿Deseas confirmar la reserva de todas formas?`);
                if (!proceed) return;
            }

            const payload = {
                nombre: document.getElementById("res-nombre").value,
                tel: document.getElementById("res-tel").value,
                origen: document.getElementById("res-origen").value,
                hotel: document.getElementById("res-hotel").value,
                hab: document.getElementById("res-hab").value,
                bono: document.getElementById("res-bono").value,
                fecha: date,
                hora: time,
                pax: pax,
                precio_pax: parseFloat(document.getElementById("res-precio-pax").value) || 0,
                precio_total: parseFloat(document.getElementById("res-precio-total").value) || 0,
                obs: document.getElementById("res-obs").value,
                updated_at: new Date().toISOString()
            };

            try {
                if (id) {
                    await db.collection("reservas_spa").doc(id).update(payload);
                } else {
                    payload.res_id = generateUID();
                    payload.status = 'confirmada';
                    payload.created_at = new Date().toISOString();
                    await db.collection("reservas_spa").add(payload);
                }

                closeModal();
                loadReservas(date);
            } catch (err) { alert(err.message); }
        });

    </script>
</body>

</html>